{% extends "layout.html" %}

{% block title %} Parent Home {% endblock %}

{% block main %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Family Dashboard</h1>
        <a href="/link" class="btn btn-outline-primary">Link New Student</a>
    </div>

<div class="row g-3 mb-4">
    <div class="col-6 col-md-4">
        <div class="card h-100 border-0 shadow-sm border-start border-danger border-4 bg-danger-subtle">
            <div class="card-body">
                <h6 class="card-subtitle mb-1 text-muted small fw-bold">OVERDUE</h6>
                <h2 class="card-title mb-0 fw-bold text-danger">{{ overdue_count }}</h2>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-4">
        <div class="card h-100 border-0 shadow-sm border-start border-warning border-4 bg-warning-subtle">
            <div class="card-body">
                <h6 class="card-subtitle mb-1 text-muted small fw-bold">DUE TODAY</h6>
                <h2 class="card-title mb-0 fw-bold text-warning-emphasis">{{ today_count }}</h2>
            </div>
        </div>
    </div>
    <div class="col-12 col-md-4">
        <div class="card h-100 border-0 shadow-sm border-start border-success border-4 bg-success-subtle">
            <div class="card-body">
                <h6 class="card-subtitle mb-1 text-muted small fw-bold">COMPLETED</h6>
                <h2 class="card-title mb-0 fw-bold text-success">{{ completed_count }}</h2>
            </div>
        </div>
    </div>
</div>

<div class="card border-0 shadow-sm rounded-4 mb-4 bg-primary-subtle">
    <div class="card-body p-4">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
            <div>
                <h5 class="fw-bold text-primary-emphasis mb-1">
                    <i class="bi bi-calendar-sync me-2"></i>Calendar Sync
                </h5>
                <p class="small text-primary-emphasis opacity-75 mb-0">
                    Sync your assignments as all-day events to Google, Apple, or Outlook.
                </p>
            </div>
            <div class="d-flex gap-2">
                {# Download Button #}
                <a href="/export_assignments/{{ session['user_id'] }}" class="btn btn-primary rounded-pill px-3 shadow-sm">
                    <i class="bi bi-download me-1"></i> Download .ics
                </a>
                {# Copy Link Button #}
                <button class="btn btn-white bg-white rounded-pill px-3 shadow-sm border" onclick="copyCalendarLink()">
                    <i class="bi bi-link-45deg me-1"></i> Copy Feed Link
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function copyCalendarLink() {
    // Construct the absolute URL for the calendar feed
    const userId = "{{ session['user_id'] }}";
    const link = window.location.origin + "/export_assignments/" + userId;
    
    navigator.clipboard.writeText(link).then(() => {
        alert("Calendar link copied! You can now 'Subscribe' to this URL in Google or Apple Calendar.");
    });
}
</script>

    {% if family_work %}

<div class="table-responsive">
    <table class="table table-hover align-middle">
        <thead>
            <tr>
                <th>Student</th>
                <th>Subject</th>
                <th>Assignment</th>
                <th>Due Date</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            <form action="/parent" method="get" class="d-flex align-items-center">
        <label for="sort" class="me-2 text-muted">Sort by:</label>
        <select name="sort" id="sort" onchange="this.form.submit()" class="form-select form-select-sm w-auto">
            <option value="child" {% if current_sort == 'child' %}selected{% endif %}>Child's Name</option>
            <option value="date" {% if current_sort == 'date' %}selected{% endif %}>Due Date</option>
            <option value="subject" {% if current_sort == 'subject' %}selected{% endif %}>Subject</option>
            <option value="name" {% if current_sort == 'name' %}selected{% endif %}>Assignment Name</option>
        </select>
    </form>
            {% for task in family_work %}
            <tr class="{% if task.status == 'Completed' %}table-success text-muted{% elif task.due_date < today %}table-danger{% elif task.due_date <= today_plus_2 %}table-warning{% endif %}">
                
                <td><strong>{{ task.username }}</strong></td>
                
                <td>
                    <span class="badge bg-secondary">{{ task.subject or "General" }}</span>
                </td>
                
                <td>{{ task.title }}</td>
                
                <td>{{ task.due_date | pretty_date }}</td>
                
                <td>
                    {% if task.status == 'Completed' %}
                        <span class="text-success"><i class="bi bi-check-circle-fill"></i> Completed</span>
                    {% else %}
                        <span class="text-dark">Pending</span>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="5" class="text-center text-muted py-4">
                    No active assignments found for your linked students.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
    {% else %}
        <div class="text-center py-5 border rounded bg-light">
            <h3 class="text-secondary">No student data available</h3>
            <p>You haven't linked any students yet, or your linked students have no assignments.</p>
            <a href="/link" class="btn btn-primary mt-2">Link a Student</a>
        </div>
    {% endif %}
{% endblock %}
