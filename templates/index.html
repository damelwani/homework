{% extends "layout.html" %}

{% block title %}
    Home
{% endblock %}

{% block main %}
    <div class="mb-4">
        <h2>Welcome, {{ username }}!</h2>
    </div>

<div class="row g-3 mb-4 text-center">
    <div class="col-md-4">
        <div class="card bg-danger-subtle border-0 shadow-sm h-100">
            <div class="card-body py-4">
                <h6 class="text-danger fw-bold text-uppercase small">Overdue</h6>
                <h2 class="display-5 fw-bold text-danger mb-0">{{ overdue_count }}</h2>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card bg-primary-subtle border-0 shadow-sm h-100">
            <div class="card-body py-4">
                <h6 class="text-primary fw-bold text-uppercase small">Due Today</h6>
                <h2 class="display-5 fw-bold text-primary mb-0">{{ today_count }}</h2>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card bg-success-subtle border-0 shadow-sm h-100">
            <div class="card-body py-4">
                <h6 class="text-success fw-bold text-uppercase small">Finished Lately</h6>
                <h2 class="display-5 fw-bold text-success mb-0">{{ completed_this_week }}</h2>
            </div>
        </div>
    </div>
</div>

<div class="card border-0 shadow-sm mb-4 bg-indigo p-3">
    <div class="d-flex align-items-center justify-content-between">
        <div>
            <h5 class="mb-0 fw-bold"><i class="bi bi-hourglass-split"></i> Focus Timer</h5>
            <small class="opacity-75" id="timer-label">Set your minutes and go!</small>
        </div>
        
        <div class="text-center d-flex align-items-center justify-content-center">
            <input type="number" id="timer-input" class="form-control form-control-lg bg-transparent border-0 fw-bold text-center p-0" 
                   value="25" min="1" max="120" style="font-size: 2.5rem; width: 80px; outline: none; box-shadow: none;">
            <span class="display-6 fw-bold" id="timer-colon">:</span>
            <span class="display-6 fw-bold" id="timer-seconds">00</span>
        </div>

        <div class="d-flex gap-2">
            <button class="btn btn-light btn-sm fw-bold" id="timer-start" onclick="toggleTimer()">Start</button>
            <button class="btn btn-outline-light btn-sm" onclick="resetTimer()">Reset</button>
        </div>
    </div>
</div>

    <div class="mb-4">
        {% if google_connected %}
            <a href="/sync_classroom" class="btn btn-success">Sync from Google</a>
            <a href="/google_login" class="btn btn-link btn-sm text-muted">Reconnect Account</a>
        {% else %}
            <a href="/google_login" class="btn btn-primary">Connect Google Classroom</a>
        {% endif %}
    </div>

    {% if assignments %}
    <div class="table-responsive shadow-sm rounded-3">
        <table class="table table-hover align-middle mb-0">
            <thead>
                <tr>
                    <th class="d-none d-md-table-cell" style="width: 15%;">Subject</th>
                    <th style="width: 40%;">Assignment</th>
                    <th style="width: 20%;">Due Date</th>
                    <th class="d-none d-sm-table-cell" style="width: 10%;">Status</th>
                    <th class="text-end" style="width: 15%;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for task in assignments %}
                <tr class="{% if task.status == 'Completed' %}table-success text-muted{% elif task.due_date < today %}table-danger{% endif %}">
                    
                    <td class="d-none d-md-table-cell">
                        <span class="badge {% if task.status == 'Completed' %}bg-secondary opacity-50{% else %}bg-indigo{% endif %}">
                            {{ task.subject or "General" }}
                        </span>
                    </td>
                    
                    <td class="fw-bold {% if task.status == 'Completed' %}text-decoration-line-through text-opacity-50{% endif %}">
                        {{ task.title }}
                    </td>
                    
                    <td class="text-nowrap">
                        <span class="{% if task.status != 'Completed' %}
                                        {% if task.due_date < today %} text-danger fw-bold
                                        {% elif task.due_date == today %} text-warning fw-bold
                                        {% elif task.due_date <= today_plus_2 %} text-primary
                                        {% endif %}
                                     {% endif %}">
                            {{ task.due_date | pretty_date }}
                        </span>

                        {% if task.status != 'Completed' %}
                            {% if task.due_date < today %}
                                <span class="badge rounded-pill bg-danger ms-1">Overdue</span>
                            {% elif task.due_date == today %}
                                <span class="badge rounded-pill bg-warning text-dark ms-1">Today</span>
                            {% elif task.due_date <= today_plus_2 %}
                                <span class="badge rounded-pill bg-info text-dark ms-1">Soon</span>
                            {% endif %}
                        {% endif %}
                    </td>
                    
                    <td class="d-none d-sm-table-cell">
                        <small class="text-uppercase fw-bold opacity-75" style="font-size: 0.7rem;">
                            {{ task.status }}
                        </small>
                    </td>
                    
                    <td class="text-end">
                        <div class="d-flex justify-content-end gap-1">
                            <form action="/update" method="post" class="d-inline">
                                <input type="hidden" name="id" value="{{ task.id }}">
                                <button type="submit" 
                                        name="status" 
                                        value="{{ 'Completed' if task.status == 'Pending' else 'Pending' }}" 
                                        class="btn btn-sm {% if task.status == 'Pending' %}btn-success{% else %}btn-outline-secondary{% endif %}"
                                        {% if task.status == 'Pending' %} onclick="celebrate()" {% endif %}>
                                    {{ "Done" if task.status == 'Pending' else "Undo" }}
                                </button>
                            </form>
                            <a href="/edit/{{ task.id }}" class="btn btn-sm btn-outline-primary">Edit</a>
                            <form action="/delete" method="post" class="d-inline" onsubmit="return confirm('Delete?');">
                                <input type="hidden" name="id" value="{{ task.id }}">
                                <button type="submit" class="btn btn-sm btn-danger">&times;</button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
        <div class="text-center py-5 border rounded bg-light">
            <h3 class="text-secondary"> No assignments due!</h3>
            <p>You're all caught up. Enjoy your free day!</p>
            <a href="/add" class="btn btn-primary mt-2">Add an Assignment</a>
        </div>
    {% endif %}
        <script>
    let timeLeft = 0;
    let timerInterval = null;
    let isRunning = false;

    const minuteInput = document.getElementById('timer-input');
    const secondDisplay = document.getElementById('timer-seconds');
    const startBtn = document.getElementById('timer-start');
    const label = document.getElementById('timer-label');

    function updateDisplay() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        
        // Update the input value for minutes and the span for seconds
        minuteInput.value = minutes;
        secondDisplay.textContent = seconds < 10 ? '0' : '' + seconds;
    }

    function toggleTimer() {
        if (isRunning) {
            // PAUSE
            clearInterval(timerInterval);
            startBtn.textContent = 'Resume';
            label.textContent = 'Paused';
            minuteInput.disabled = false;
        } else {
            // START
            if (timeLeft <= 0) {
                timeLeft = parseInt(minuteInput.value) * 60;
            }
            
            label.textContent = 'Stay Focused!';
            startBtn.textContent = 'Pause';
            minuteInput.disabled = true; // Lock input while running

            timerInterval = setInterval(() => {
                timeLeft--;
                updateDisplay();
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    alert("Time's up! Great work.");
                    resetTimer();
                }
            }, 1000);
        }
        isRunning = !isRunning;
    }

    function resetTimer() {
        clearInterval(timerInterval);
        isRunning = false;
        timeLeft = 0;
        minuteInput.disabled = false;
        minuteInput.value = 25; // Or whatever default you want
        secondDisplay.textContent = "00";
        startBtn.textContent = 'Start';
        label.textContent = 'Ready to work?';
    }
</script>
{% endblock %}
